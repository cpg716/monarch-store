# MonARCH Store - Cursor Rules

## Project Architecture
This is a Tauri v2 application with a split architecture:
1. **Frontend:** React + TypeScript + Tailwind (Glassmorphism UI). State: Zustand in `src/store/`. Key dirs: `src/components/`, `src/pages/`, `src/hooks/`.
2. **Backend (GUI):** `src-tauri/monarch-gui/`. Runs as USER. Handles Read-Only ALPM, Configuration, and IPC. Key: `commands/`, `helper_client.rs`, `alpm_read.rs`.
3. **Backend (Helper):** `src-tauri/monarch-helper/`. Runs as ROOT (via Polkit). Handles Write ALPM (Install/Update/Remove). Key: `transactions.rs`, `main.rs`, `self_healer.rs`, `alpm_errors.rs`, `logger.rs`.

## Critical Rules
- **NEVER** suggest running `makepkg` or AUR builds in `monarch-helper` (Root). Builds MUST happen in `monarch-gui` (User).
- **No Sudo in GUI:** The GUI must **NEVER** run `sudo` (or `Command::new("sudo")`) for system tasks. It has no TTY; use the Helper via `invoke_helper` with the appropriate `HelperCommand` (e.g. `RemoveLock`, `ClearCache`, `ForceRefreshDb`). See `.cursor/CONTEXT.md` â€” Critical Architecture Update (Jan 31, 2026).
- **IPC Protocol:** The GUI invokes the Helper with the command JSON as **argv** (e.g. `pkexec /path/to/monarch-helper` with command file or stdin). The Helper replies via **stdout** JSON lines (progress/events). Stdin is only used for sudo password when the GUI spawns sudo for the **invocation** (e.g. `sudo -S` to run the helper); the GUI must not run sudo for the **operation** itself (lock rm, cache clean, etc.).
- **ALPM Safety:** In `monarch-helper`, check for `db.lck` before sysupgrade (see `main.rs` Sysupgrade branch). Use `alpm::TransFlag` (e.g. `ALL_DEPS`, `DOWNLOAD_ONLY`). Use the question callback to auto-answer (NOCONFIRM behavior).
- **Package Management:** Never run `pacman -Sy` alone; use a single transaction (e.g. `-Syu`). AUR: build in GUI, copy built `.pkg.tar.zst` to `/tmp/monarch-install/` before calling Helper `AlpmInstallFiles`.

## Coding Style
- **Rust:** Prefer `anyhow` or `thiserror` for error handling. Use `serde` for all IPC structs. In helper, use `logger::trace`/`info` for diagnostics (log file: `/var/log/monarch-helper.log` or `/tmp/monarch-helper.log`).
- **React:** Functional components, `lucide-react` icons, `clsx` + `tailwind-merge` for class names. Tauri: `invoke()` from `@tauri-apps/api/core`.
- **Tauri:** Use `tauri::command` for frontend-to-gui communication.

## Context Awareness
- **Updates:** `monarch-gui/src/commands/update.rs` AND `monarch-helper/src/transactions.rs` (and Sysupgrade/lock check in `main.rs`).
- **Search:** `monarch-gui/src/commands/search.rs` and `monarch-gui/src/alpm_read.rs`.
- **Install/Uninstall:** `monarch-gui/src/commands/package.rs`, `helper_client.rs`, `monarch-helper/src/transactions.rs`.
- **Install cancel:** `repair.rs` `cancel_install` (creates `/var/tmp/monarch-cancel`, helper exits, then RemoveLock). Helper: PID file + watcher for cancel file. InstallMonitor: Cancel button + close warning. **Startup unlock:** `unlock_pacman_if_stale` runs at app startup (App.tsx) before health/sync; clears stale db.lck via Helper RemoveLock when safe.
- **Errors:** `monarch-helper/src/alpm_errors.rs` (classify) + `src/utils/friendlyError.ts` (frontend). Self-heal: `monarch-helper/src/self_healer.rs`.

## Build
- Full app: `npm run tauri dev` or `npm run tauri build`. Rust only: `cd src-tauri && cargo check`. See `AGENTS.md` for more.
